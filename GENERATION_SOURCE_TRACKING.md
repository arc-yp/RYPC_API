# Generation Source Tracking Implementation

## Summary

Successfully implemented tracking to distinguish between automatically generated reviews (first load) and manually regenerated reviews (via "Generate New Review" button).

## Changes Made

### 1. Database Schema (`generated_reviews` table)

**New Column Added:** `generation_source`

- Type: `TEXT`
- Values: `'auto'` or `'manual'`
- Default: `'auto'`
- Constraint: CHECK constraint ensures only valid values

**Migration File:** `supabase/migrations/20251201000000_add_generation_source.sql`

```sql
ALTER TABLE generated_reviews
ADD COLUMN IF NOT EXISTS generation_source TEXT DEFAULT 'auto'
CHECK (generation_source IN ('auto', 'manual'));
```

### 2. TypeScript Interface Update

**File:** `src/types/index.ts`

Added `generationSource` field to `GeneratedReviewRecord`:

```typescript
export interface GeneratedReviewRecord {
  // ... existing fields
  generationSource?: "auto" | "manual";
  // 'auto' = first load (automatic)
  // 'manual' = Generate New Review button clicked
}
```

### 3. Review Store Service Update

**File:** `src/components/ReviewStore/reviewStore.ts`

- Updated `saveReview()` to accept and store `generation_source`
- Updated `getAllReviews()` to return `generationSource` field
- Updated `getReviewsByBusiness()` to return `generationSource` field
- Updated `getReviewsByCategory()` to return `generationSource` field

### 4. CompactReviewCardView Update

**File:** `src/components/CompactReviewCardView.tsx`

Modified the `generateReviewForRating()` function to track generation source:

```typescript
await reviewStore.saveReview({
  // ... other fields
  generationSource: hasGeneratedInitialReview.current ? "manual" : "auto",
});
```

**Logic:**

- `hasGeneratedInitialReview.current` is `false` initially â†’ saves as `'auto'`
- After first generation, it becomes `true` â†’ subsequent generations save as `'manual'`

### 5. UI Badge Display

**Files Updated:**

- `src/components/ReviewStore/ReviewArchivePage.tsx`
- `src/components/ReviewStore/ReviewCategoryPage.tsx`

Added purple "Manual" badge for manually regenerated reviews:

```tsx
{
  r.generationSource === "manual" && (
    <span className="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-50 text-purple-700 border border-purple-200">
      ðŸ”„ Manual
    </span>
  );
}
```

## How It Works

### User Journey:

1. **First Time Opening Card:**

   - Review is automatically generated
   - Saved to database with `generation_source = 'auto'`
   - No special badge shown (it's the default)

2. **Clicking "Generate New Review" Button:**
   - New review is generated
   - Saved to database with `generation_source = 'manual'`
   - Purple "ðŸ”„ Manual" badge appears in review archive/category pages

### Visual Indicators in Archive:

Each review card now shows:

- **AI Badge** (Blue) - Successfully generated by AI
- **Fallback Badge** (Amber) - Fallback review when API fails
- **Manual Badge** (Purple) - Generated by clicking "Generate New Review" button

## Database Migration Steps

### Option 1: Run via Supabase CLI

```bash
supabase db push
```

### Option 2: Run SQL Directly in Supabase Dashboard

1. Go to Supabase Dashboard â†’ SQL Editor
2. Create new query
3. Paste the contents of `supabase/migrations/20251201000000_add_generation_source.sql`
4. Run the query

### Option 3: Manual SQL

```sql
ALTER TABLE generated_reviews
ADD COLUMN IF NOT EXISTS generation_source TEXT DEFAULT 'auto'
CHECK (generation_source IN ('auto', 'manual'));

COMMENT ON COLUMN generated_reviews.generation_source IS 'Tracks how the review was generated: auto (first load) or manual (Generate New Review button)';

CREATE INDEX IF NOT EXISTS idx_generated_reviews_generation_source ON generated_reviews(generation_source);

UPDATE generated_reviews
SET generation_source = 'auto'
WHERE generation_source IS NULL;
```

## Benefits

1. **Analytics:** Track how many users regenerate reviews vs. using the first one
2. **Quality Monitoring:** Compare quality between auto and manually generated reviews
3. **User Behavior:** Understand if initial reviews meet user needs
4. **A/B Testing:** Test different auto-generation strategies
5. **Debugging:** Identify which reviews were regenerated due to quality issues

## Future Enhancements

You can now easily add:

- Filter reviews by generation source in dashboard
- Show statistics: "X% of users regenerate reviews"
- Track average regenerations per card
- Compare ratings between auto vs manual reviews
- Alert if certain cards have high regeneration rates (may indicate quality issues)

## Example Queries

### Count auto vs manual reviews:

```sql
SELECT generation_source, COUNT(*)
FROM generated_reviews
GROUP BY generation_source;
```

### Find businesses with high regeneration rates:

```sql
SELECT business_name,
       COUNT(*) as total_reviews,
       SUM(CASE WHEN generation_source = 'manual' THEN 1 ELSE 0 END) as manual_count
FROM generated_reviews
GROUP BY business_name
ORDER BY manual_count DESC;
```

### Reviews by category and source:

```sql
SELECT category, generation_source, COUNT(*)
FROM generated_reviews
GROUP BY category, generation_source
ORDER BY category, generation_source;
```
